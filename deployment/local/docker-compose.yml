services:
  api-server:
    build:
      context: ../..
      dockerfile: packages/api-server/Dockerfile
    container_name: api-server
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    environment:
      - PORT=3001
      - NODE_ENV=development
      - TZ=Europe/Berlin
      # Email - inbound SMTP receiver
      - SMTP_RECEIVER_PORT=2525
      - SMTP_DOMAIN=${SMTP_DOMAIN}
      # Email - outbound SMTP relay (Resend)
      - SMTP_MODE=${SMTP_MODE:-relay}
      - SMTP_HOST=${SMTP_HOST}
      - SMTP_PORT=${SMTP_PORT:-465}
      - SMTP_SECURE=${SMTP_SECURE:-true}
      - SMTP_USER=${SMTP_USER}
      - SMTP_PASS=${SMTP_PASS}
    volumes:
      - ./data:/app/packages/api-server/data
    networks:
      - internal

  scraping-server:
    build:
      context: ../..
      dockerfile: packages/scraping-server/Dockerfile
    container_name: scraping-server
    restart: unless-stopped
    environment:
      - NODE_ENV=development
      - TZ=Europe/Berlin
      - API_SERVER_URL=http://api-server:3001
      # Kleinanzeigen account for messaging
      - KLEINANZEIGEN_EMAIL=${KLEINANZEIGEN_EMAIL}
      - KLEINANZEIGEN_PASSWORD=${KLEINANZEIGEN_PASSWORD}
    volumes:
      - scraper-html:/app/packages/scraping-server/data
      - ./proxies.txt:/app/packages/scraping-server/proxies.txt:ro
    shm_size: "2gb"
    networks:
      - internal
    depends_on:
      api-server:
        condition: service_healthy

  panel:
    build:
      context: ../..
      dockerfile: deployment/local/Dockerfile.dev.panel
    container_name: panel
    restart: unless-stopped
    ports:
      - "5173:5173"
    environment:
      - NODE_ENV=development
      - API_SERVER_URL=http://api-server:3001
    volumes:
      - ../../packages/panel/src:/app/packages/panel/src
      - ../../packages/panel/index.html:/app/packages/panel/index.html
      - ../../packages/panel/vite.config.ts:/app/packages/panel/vite.config.ts
      - ../../packages/panel/tsconfig.json:/app/packages/panel/tsconfig.json
      - ../../packages/api-types/src:/app/packages/api-types/src
    networks:
      - internal
    depends_on:
      - api-server

  caddy:
    image: caddy:2-alpine
    container_name: caddy
    restart: unless-stopped
    ports:
      - "8080:8080"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy-data:/data
      - caddy-config:/config
    networks:
      - internal
    depends_on:
      - api-server
      - panel

volumes:
  scraper-html:
  caddy-data:
  caddy-config:

networks:
  internal:
