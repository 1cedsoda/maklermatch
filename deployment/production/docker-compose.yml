services:
  api-server:
    build:
      context: ../..
      dockerfile: packages/api-server/Dockerfile
    container_name: api-server
    restart: unless-stopped
    ports:
      - "25:2525"
    environment:
      - PORT=3001
      - NODE_ENV=production
      - TZ=Europe/Berlin
      # Email - inbound SMTP receiver
      - SMTP_RECEIVER_PORT=2525
      - SMTP_DOMAIN=${SMTP_DOMAIN}
      # Email - outbound SMTP relay (Resend)
      - SMTP_MODE=${SMTP_MODE:-relay}
      - SMTP_HOST=${SMTP_HOST}
      - SMTP_PORT=${SMTP_PORT:-465}
      - SMTP_SECURE=${SMTP_SECURE:-true}
      - SMTP_USER=${SMTP_USER}
      - SMTP_PASS=${SMTP_PASS}
    volumes:
      - ./data:/app/packages/api-server/data
    networks:
      - internal

  scraping-server:
    build:
      context: ../..
      dockerfile: packages/scraping-server/Dockerfile
    container_name: scraping-server
    restart: unless-stopped
    environment:
      - NODE_ENV=production
      - TZ=Europe/Berlin
      - API_SERVER_URL=http://api-server:3001
      # Kleinanzeigen account for messaging
      - KLEINANZEIGEN_EMAIL=${KLEINANZEIGEN_EMAIL}
      - KLEINANZEIGEN_PASSWORD=${KLEINANZEIGEN_PASSWORD}
    volumes:
      - scraper-html:/app/packages/scraping-server/data
      - ./proxies.txt:/app/packages/scraping-server/proxies.txt:ro
    shm_size: "2gb"
    networks:
      - internal
    depends_on:
      - api-server

  caddy:
    build:
      context: ../..
      dockerfile: deployment/production/Dockerfile.caddy
    container_name: caddy
    restart: unless-stopped
    ports:
      - "8443:8443"
      - "80:80"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy-data:/data
      - caddy-config:/config
    networks:
      - internal
    depends_on:
      - api-server

volumes:
  scraper-html:
  caddy-data:
  caddy-config:

networks:
  internal:
